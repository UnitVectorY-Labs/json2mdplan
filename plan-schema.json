{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "title": "json2mdplan Plan v1",
  "description": "A directive-based plan that guides deterministic JSON-to-Markdown rendering through sequential execution of operators.",
  "properties": {
    "version": {
      "type": "integer",
      "description": "Plan format version. Must be 1 for this schema.",
      "const": 1
    },
    "schema_fingerprint": {
      "type": "object",
      "description": "Fingerprint of the JSON Schema used to generate this plan. Used to enforce strict compatibility.",
      "properties": {
        "sha256": {
          "type": "string",
          "description": "SHA-256 hash of the canonicalized, resolved schema."
        },
        "canonicalization": {
          "type": "string",
          "description": "Name of the canonicalization algorithm used prior to hashing."
        },
        "source_hint": {
          "type": "string",
          "description": "Optional human hint, e.g. schema file name or identifier."
        }
      },
      "required": ["sha256", "canonicalization"],
      "additionalProperties": false
    },
    "settings": {
      "type": "object",
      "description": "Global rendering settings.",
      "properties": {
        "base_heading_level": {
          "type": "integer",
          "description": "Starting Markdown heading level at the document root. Typical value is 1.",
          "minimum": 1,
          "maximum": 6,
          "default": 1
        },
        "null_text": {
          "type": "string",
          "description": "Default text to display for null values.",
          "default": "null"
        }
      },
      "required": ["base_heading_level"],
      "additionalProperties": false
    },
    "directives": {
      "type": "array",
      "description": "Sequential list of directives to execute. Each directive emits zero or more lines of Markdown.",
      "items": {
        "$ref": "#/$defs/directive"
      }
    }
  },
  "required": ["version", "schema_fingerprint", "settings", "directives"],
  "additionalProperties": false,
  "$defs": {
    "directive": {
      "type": "object",
      "oneOf": [
        {"$ref": "#/$defs/heading"},
        {"$ref": "#/$defs/blank_line"},
        {"$ref": "#/$defs/text_line"},
        {"$ref": "#/$defs/labeled_value_line"},
        {"$ref": "#/$defs/for_each"},
        {"$ref": "#/$defs/with_scope"},
        {"$ref": "#/$defs/if_present"},
        {"$ref": "#/$defs/bullet_list"},
        {"$ref": "#/$defs/suppress"}
      ]
    },
    "heading": {
      "type": "object",
      "properties": {
        "op": {"const": "heading"},
        "id": {"type": "string", "description": "Optional identifier for debugging"},
        "level": {"type": "integer", "minimum": 1, "maximum": 6, "description": "Absolute heading level (1-6)"},
        "level_from_base": {"type": "integer", "description": "Heading level relative to base_heading_level"},
        "text": {"$ref": "#/$defs/text_union"},
        "when": {"$ref": "#/$defs/condition"}
      },
      "required": ["op", "text"],
      "oneOf": [
        {"required": ["level"]},
        {"required": ["level_from_base"]}
      ],
      "additionalProperties": false
    },
    "blank_line": {
      "type": "object",
      "properties": {
        "op": {"const": "blank_line"},
        "id": {"type": "string"},
        "count": {"type": "integer", "minimum": 1, "default": 1},
        "when": {"$ref": "#/$defs/condition"}
      },
      "required": ["op"],
      "additionalProperties": false
    },
    "text_line": {
      "type": "object",
      "properties": {
        "op": {"const": "text_line"},
        "id": {"type": "string"},
        "text": {"$ref": "#/$defs/text_union"},
        "escape": {"type": "boolean", "default": true, "description": "Whether to escape Markdown special characters"},
        "style": {"enum": ["plain", "bold", "italic", "code_inline"], "default": "plain"},
        "prefix": {"type": "string", "description": "Literal prefix (e.g., '- ' for bullets)"},
        "suffix": {"type": "string", "description": "Literal suffix"},
        "when": {"$ref": "#/$defs/condition"}
      },
      "required": ["op", "text"],
      "additionalProperties": false
    },
    "labeled_value_line": {
      "type": "object",
      "properties": {
        "op": {"const": "labeled_value_line"},
        "id": {"type": "string"},
        "label": {"$ref": "#/$defs/text_union"},
        "value": {"$ref": "#/$defs/value_reference"},
        "label_style": {"enum": ["bold", "plain"], "default": "bold"},
        "separator": {"type": "string", "default": ": "},
        "value_format": {"$ref": "#/$defs/value_format"},
        "skip_if_missing": {"type": "boolean", "default": true},
        "when": {"$ref": "#/$defs/condition"}
      },
      "required": ["op", "label", "value"],
      "additionalProperties": false
    },
    "for_each": {
      "type": "object",
      "properties": {
        "op": {"const": "for_each"},
        "id": {"type": "string"},
        "array": {"$ref": "#/$defs/value_reference"},
        "as": {"type": "string", "description": "Optional name for the loop scope"},
        "index_as": {"type": "string", "description": "Optional name for the index variable"},
        "do": {
          "type": "array",
          "items": {"$ref": "#/$defs/directive"},
          "description": "Directives to execute for each item"
        },
        "between_items": {
          "type": "array",
          "items": {"$ref": "#/$defs/directive"},
          "description": "Directives to execute between items"
        },
        "when": {"$ref": "#/$defs/condition"}
      },
      "required": ["op", "array", "do"],
      "additionalProperties": false
    },
    "with_scope": {
      "type": "object",
      "properties": {
        "op": {"const": "with_scope"},
        "id": {"type": "string"},
        "value": {"$ref": "#/$defs/value_reference"},
        "as": {"type": "string", "description": "Optional name for the scope"},
        "do": {
          "type": "array",
          "items": {"$ref": "#/$defs/directive"},
          "description": "Directives to execute in this scope"
        },
        "when": {"$ref": "#/$defs/condition"}
      },
      "required": ["op", "value", "do"],
      "additionalProperties": false
    },
    "if_present": {
      "type": "object",
      "properties": {
        "op": {"const": "if_present"},
        "id": {"type": "string"},
        "value": {"$ref": "#/$defs/value_reference"},
        "mode": {"enum": ["exists", "non_null", "non_empty"], "default": "non_null"},
        "then": {
          "type": "array",
          "items": {"$ref": "#/$defs/directive"}
        },
        "else": {
          "type": "array",
          "items": {"$ref": "#/$defs/directive"}
        }
      },
      "required": ["op", "value", "then"],
      "additionalProperties": false
    },
    "bullet_list": {
      "type": "object",
      "properties": {
        "op": {"const": "bullet_list"},
        "id": {"type": "string"},
        "items": {"$ref": "#/$defs/value_reference"},
        "item_format": {"$ref": "#/$defs/value_format"},
        "item_text": {"$ref": "#/$defs/text_union", "description": "For array of objects, text to evaluate per item"},
        "bullet": {"type": "string", "default": "- "},
        "skip_empty": {"type": "boolean", "default": true},
        "when": {"$ref": "#/$defs/condition"}
      },
      "required": ["op", "items"],
      "oneOf": [
        {"required": ["item_format"]},
        {"required": ["item_text"]}
      ],
      "additionalProperties": false
    },
    "suppress": {
      "type": "object",
      "properties": {
        "op": {"const": "suppress"},
        "id": {"type": "string"},
        "path": {"type": "string", "description": "JSON Pointer to suppress"},
        "reason": {"type": "string", "description": "Optional explanation"}
      },
      "required": ["op", "path"],
      "additionalProperties": false
    },
    "text_union": {
      "oneOf": [
        {
          "type": "object",
          "properties": {
            "literal": {"type": "string"}
          },
          "required": ["literal"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "properties": {
            "value": {"$ref": "#/$defs/value_reference"}
          },
          "required": ["value"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "properties": {
            "schema_title": {
              "type": "object",
              "properties": {
                "path": {"type": "string"},
                "fallback": {"type": "string"}
              },
              "required": ["path"],
              "additionalProperties": false
            }
          },
          "required": ["schema_title"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "properties": {
            "concat": {
              "type": "array",
              "items": {"$ref": "#/$defs/text_union"}
            }
          },
          "required": ["concat"],
          "additionalProperties": false
        }
      ]
    },
    "value_reference": {
      "type": "object",
      "properties": {
        "path": {"type": "string", "description": "JSON Pointer path"},
        "from": {"enum": ["root", "current"], "default": "root"}
      },
      "required": ["path"],
      "additionalProperties": false
    },
    "value_format": {
      "enum": ["text", "number", "boolean", "date", "datetime", "json_compact"]
    },
    "condition": {
      "type": "object",
      "properties": {
        "value": {"$ref": "#/$defs/value_reference"},
        "test": {"enum": ["exists", "non_null", "non_empty", "equals_literal"]},
        "literal": {"description": "Value for equals_literal test"}
      },
      "required": ["value", "test"],
      "additionalProperties": false
    }
  }
}
