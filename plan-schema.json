{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "json2mdplan Gemini Plan (generation schema)",
  "type": "object",
  "additionalProperties": false,
  "required": ["version", "settings", "directives"],
  "properties": {
    "version": { "type": "integer", "enum": [1], "description": "Must be 1." },
    "settings": {
      "type": "object",
      "additionalProperties": false,
      "required": ["base_heading_level"],
      "properties": {
        "base_heading_level": { "type": "integer", "minimum": 1, "maximum": 6 },
        "null_text": { "type": "string" }
      }
    },
    "directives": {
      "type": "array",
      "items": { "type": "object", "additionalProperties": false, "required": ["op"], "properties": {
        "op": {
          "type": "string",
          "enum": [
            "heading",
            "blank_line",
            "text_line",
            "labeled_value_line",
            "for_each",
            "with_scope",
            "if_present",
            "bullet_list",
            "suppress"
          ]
        },
        "id": { "type": "string" },

        "when": {
          "type": "object",
          "additionalProperties": false,
          "required": ["value", "test"],
          "properties": {
            "value": {
              "type": "object",
              "additionalProperties": false,
              "required": ["path"],
              "properties": {
                "path": { "type": "string", "description": "JSON Pointer" },
                "from": { "type": "string", "enum": ["root", "current"] }
              }
            },
            "test": { "type": "string", "enum": ["exists", "non_null", "non_empty", "equals_literal"] },
            "literal": {
              "type": ["string", "number", "integer", "boolean", "null"],
              "description": "Only used when test=equals_literal"
            }
          }
        },

        "level": { "type": "integer", "minimum": 1, "maximum": 6, "description": "Required when op=heading (use level or level_from_base)" },
        "level_from_base": { "type": "integer", "description": "Required when op=heading (use level or level_from_base)" },
        "text": { "$comment": "TextUnion", "type": "object", "additionalProperties": false, "required": ["kind"], "properties": {
          "kind": { "type": "string", "enum": ["literal", "value", "schema_title", "concat"] },

          "literal": { "type": "string", "description": "Used when kind=literal" },

          "value": {
            "type": "object",
            "additionalProperties": false,
            "required": ["path"],
            "properties": {
              "path": { "type": "string" },
              "from": { "type": "string", "enum": ["root", "current"] }
            },
            "description": "Used when kind=value"
          },

          "schema_title": {
            "type": "object",
            "additionalProperties": false,
            "required": ["path"],
            "properties": {
              "path": { "type": "string" },
              "fallback": { "type": "string" }
            },
            "description": "Used when kind=schema_title"
          },

          "concat": {
            "type": "array",
            "items": { "$comment": "TextUnion", "type": "object", "additionalProperties": false, "required": ["kind"], "properties": {
              "kind": { "type": "string", "enum": ["literal", "value", "schema_title", "concat"] },
              "literal": { "type": "string" },
              "value": {
                "type": "object",
                "additionalProperties": false,
                "required": ["path"],
                "properties": {
                  "path": { "type": "string" },
                  "from": { "type": "string", "enum": ["root", "current"] }
                }
              },
              "schema_title": {
                "type": "object",
                "additionalProperties": false,
                "required": ["path"],
                "properties": {
                  "path": { "type": "string" },
                  "fallback": { "type": "string" }
                }
              },
              "concat": { "type": "array", "items": { "type": "object" } }
            } }
          }
        }, "description": "Required when op=heading or op=text_line, etc." },

        "count": { "type": "integer", "minimum": 1, "description": "Used when op=blank_line" },

        "escape": { "type": "boolean", "description": "Used when op=text_line" },
        "style": { "type": "string", "enum": ["plain", "bold", "italic", "code_inline"], "description": "Used when op=text_line" },
        "prefix": { "type": "string", "description": "Used when op=text_line" },
        "suffix": { "type": "string", "description": "Used when op=text_line" },

        "label": { "$comment": "TextUnion", "type": "object", "additionalProperties": false, "required": ["kind"], "properties": {
          "kind": { "type": "string", "enum": ["literal", "value", "schema_title", "concat"] },
          "literal": { "type": "string" },
          "value": {
            "type": "object",
            "additionalProperties": false,
            "required": ["path"],
            "properties": { "path": { "type": "string" }, "from": { "type": "string", "enum": ["root", "current"] } }
          },
          "schema_title": {
            "type": "object",
            "additionalProperties": false,
            "required": ["path"],
            "properties": { "path": { "type": "string" }, "fallback": { "type": "string" } }
          },
          "concat": { "type": "array", "items": { "type": "object" } }
        }, "description": "Used when op=labeled_value_line" },

        "value": {
          "type": "object",
          "additionalProperties": false,
          "required": ["path"],
          "properties": {
            "path": { "type": "string" },
            "from": { "type": "string", "enum": ["root", "current"] }
          },
          "description": "Used when op=labeled_value_line or op=if_present or op=with_scope"
        },

        "label_style": { "type": "string", "enum": ["bold", "plain"] },
        "separator": { "type": "string" },
        "value_format": { "type": "string", "enum": ["text", "number", "boolean", "date", "datetime", "json_compact"] },
        "skip_if_missing": { "type": "boolean" },

        "array": {
          "type": "object",
          "additionalProperties": false,
          "required": ["path"],
          "properties": {
            "path": { "type": "string" },
            "from": { "type": "string", "enum": ["root", "current"] }
          },
          "description": "Used when op=for_each"
        },

        "do": { "type": "array", "items": { "type": "object" }, "description": "Used when op=for_each or op=with_scope" },
        "between_items": { "type": "array", "items": { "type": "object" }, "description": "Used when op=for_each" },

        "mode": { "type": "string", "enum": ["exists", "non_null", "non_empty"], "description": "Used when op=if_present" },
        "then": { "type": "array", "items": { "type": "object" }, "description": "Used when op=if_present" },
        "else": { "type": "array", "items": { "type": "object" }, "description": "Used when op=if_present" },

        "items": {
          "type": "object",
          "additionalProperties": false,
          "required": ["path"],
          "properties": {
            "path": { "type": "string" },
            "from": { "type": "string", "enum": ["root", "current"] }
          },
          "description": "Used when op=bullet_list"
        },
        "item_format": { "type": "string", "enum": ["text", "number", "boolean", "date", "datetime", "json_compact"] },
        "item_text": { "$comment": "TextUnion", "type": "object" },
        "bullet": { "type": "string" },
        "skip_empty": { "type": "boolean" },

        "path": { "type": "string", "description": "Used when op=suppress" },
        "reason": { "type": "string" }
      } }
    }
  }
}